var toot = {
    //gravity: (300 * 0.27),
    gravity: 300,
    fartStrength: 250
};
toot.environment = {};
toot.character = {};


var run = function() {

    var stats = new Stats();
    document.body.appendChild(stats.domElement);
    stats.domElement.style.position = 'absolute';
    stats.domElement.style.top = '0px';

    var game = new Phaser.Game(
        1334, 750,
        Phaser.AUTO,
        '', {
            preload: preload,
            create: create,
            update: update
        });

    //var cursors;
    var player = new toot.character.Player(game);
    var ground = new toot.environment.Ground(game);
    var background = new toot.environment.Background(game);
    var vignette = new toot.environment.Vignette(game);

    function preload () {
        background.preload();
        ground.preload();
        player.preload();
        vignette.preload();
    }

    function create () {

        game.physics.startSystem(Phaser.Physics.ARCADE);

        game.scale.scaleMode = Phaser.ScaleManager.SHOW_ALL;
        game.scale.pageAlignHorizontally = true;
        game.scale.pageAlignVertically = true;
        game.scale.setScreenSize(true);
        game.scale.refresh();

        // Create game objects
        background.create();
        ground.create();
        player.create();
        vignette.create();

        // Key Input
        //cursors = game.input.keyboard.createCursorKeys();
    }

    function update() {
        stats.begin();

        game.physics.arcade.collide(player.getColliders(), ground.getColliders());

        background.update();
        ground.update();
        player.update();

        stats.end();
    }

};


toot.character.Player = function(game) {
    this.game = game;
    this.sprite;
};

toot.character.Player.prototype.preload = function() {
    this.game.load.spritesheet('dude', 'assets/dude.png', 32, 48);
};

toot.character.Player.prototype.create = function() {
    // player
    var startX = this.game.world.width * 0.15;
    var startY = this.game.world.height - 256;

    this.sprite = this.game.add.sprite(startX, startY, 'dude');
    this.game.physics.arcade.enable(this.sprite);
    //this.sprite.body.bounce.y = 0.1;
    this.sprite.body.gravity.y = toot.gravity;
    this.sprite.body.collideWorldBounds = true;

    //this.sprite.animations.add('right', [5, 6, 7, 8], 10, true);
    this.sprite.animations.add('run', [5, 6, 7, 8], 5, true);
    this.sprite.animations.add('land', [5, 6, 7, 8], 3, true);
};

toot.character.Player.prototype.update = function(cursors) {
    //  Reset the players velocity (movement)
    this.sprite.body.velocity.x = 0;

    //console.log(this.sprite.body.velocity.y);

    if (this.game.input.activePointer.isDown) {
        this.sprite.body.velocity.y = toot.fartStrength * -1;
    }

    if (this.sprite.body.touching.down) {
        this.sprite.animations.play('run');
    }
    else if (this.sprite.body.velocity.y > 0 &&
             this.sprite.body.velocity.y > (toot.fartStrength * 0.66)) {
        this.sprite.animations.play('land');
    }
    else {
        this.sprite.frame = 8;
    }

};

toot.character.Player.prototype.getColliders = function() {
    return this.sprite;
};


toot.environment.Background = function(game) {
    this.game = game;
};

toot.environment.Background.prototype.preload = function() {
    this.game.load.image('bg-space', 'images/bg-space.jpg');
    this.game.load.image('bg-stars-small', 'images/bg-stars-small.png');
    this.game.load.image('bg-stars-large', 'images/bg-stars-large.png');
};

toot.environment.Background.prototype.create = function() {
    var w = this.game.world.width;
    var h = this.game.world.height;
    this.spaceBg = this.game.add.tileSprite(0, 0, w, h, 'bg-space');
    this.starsSm = this.game.add.tileSprite(0, 0, w, h, 'bg-stars-small');
    this.starsLg = this.game.add.tileSprite(0, 0, w, h, 'bg-stars-large');
};

toot.environment.Background.prototype.update = function() {
    this.spaceBg.tilePosition.x -= 0.1;
    this.starsSm.tilePosition.x -= 0.2;
    this.starsLg.tilePosition.x -= 0.3;

};


toot.environment.Ground = function(game) {
    this.game = game;
    this.group;
};

toot.environment.Ground.prototype.preload = function() {
    this.game.load.image('ground', 'images/ground.jpg');
};

toot.environment.Ground.prototype.create = function() {
    var w = this.game.world.width;
    var h = this.game.world.height;
    //this.group = this.game.add.group();
    //this.group.enableBody = true;
    //var g = this.group.create(0, this.game.world.height - 48, 'ground');
    //g.scale.setTo(0.5, 0.5);
    //g.body.immovable = true;
    var yPos = h - 64;
    this.ground = this.game.add.tileSprite(0, yPos, w, h, 'ground');

    this.game.physics.arcade.enable(this.ground);
    this.ground.body.immovable = true;

    // bug in phaser 2.3.0
    // see: http://www.html5gamedevs.com/topic/13856-problem-with-collide-method-from-physics-arcade-in-different-versions-of-phaser/?p=79032
    this.ground.physicsType = Phaser.SPRITE;
};

toot.environment.Ground.prototype.update = function() {
    this.ground.tilePosition.x -= 0.4;
};

toot.environment.Ground.prototype.getColliders = function() {
    return this.ground;
};

toot.environment.Vignette = function(game) {
    this.game = game;
};

toot.environment.Vignette.prototype.preload = function() {
    this.game.load.image('vignette', 'images/vignette.png');
};

toot.environment.Vignette.prototype.create = function() {
    var w = this.game.world.width;
    var h = this.game.world.height;
    this.v = this.game.add.sprite(0, 0, 'vignette');
};
